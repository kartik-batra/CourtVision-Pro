{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{{ case.title }} - CourtVision Pro{% endblock %}

<body data-page="case-detail">
{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'legal_research:search' %}">{% trans "Search" %}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ case.title|truncatechars:80 }}</li>
        </ol>
    </nav>

    <!-- Case Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h1 class="h4 mb-2">{{ case.title }}</h1>
                            <p class="mb-1">
                                <strong>{% trans "Citation" %}:</strong> {{ case.citation }}
                            </p>
                            <p class="mb-0">
                                <strong>{% trans "Court" %}:</strong> {{ case.court.name }}
                                {% if case.bench %}• {{ case.bench }}{% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark mb-2">{{ case.get_case_type_display }}</span>
                            <p class="mb-0">
                                <small class="text-muted">
                                    {% trans "Judgment Date" %}: {{ case.judgment_date }}
                                </small>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Case Actions -->
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-outline-primary btn-sm" id="saveCaseBtn" data-case-id="{{ case.id }}">
                            <i class="bi bi-bookmark me-1"></i>
                            {% if is_saved %}{% trans "Saved" %}{% else %}{% trans "Save Case" %}{% endif %}
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-download me-1"></i>{% trans "Export" %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="{% url 'legal_research:export_case' case.id %}?format=pdf">
                                    <i class="bi bi-file-pdf me-2"></i>{% trans "PDF" %}
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'legal_research:export_case' case.id %}?format=txt">
                                    <i class="bi bi-file-text me-2"></i>{% trans "Text" %}
                                </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" id="copyLinkBtn">
                            <i class="bi bi-link-45deg me-1"></i>{% trans "Copy Link" %}
                        </button>
                    </div>

                    <!-- Case Metadata -->
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2">
                                <strong>{% trans "Decision Date" %}:</strong> {{ case.decision_date }}
                            </p>
                            <p class="mb-2">
                                <strong>{% trans "View Count" %}:</strong> {{ case.view_count }}
                            </p>
                            <p class="mb-2">
                                <strong>{% trans "Relevance Score" %}:</strong>
                                <span class="badge bg-info">{{ case.relevance_score|floatformat:2 }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2">
                                <strong>{% trans "Tags" %}:</strong>
                                {% for tag in case.tags.all %}
                                    <span class="badge bg-secondary me-1">{{ tag.name }}</span>
                                {% empty %}
                                    <span class="text-muted">{% trans "No tags" %}</span>
                                {% endfor %}
                            </p>
                            <p class="mb-0">
                                <strong>{% trans "AI Processing" %}:</strong>
                                <span class="badge bg-{{ case.ai_processing_status|yesno:'success,warning,danger' }}">
                                    {{ case.get_ai_processing_status_display }}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Content -->
    <div class="row g-4">
        <!-- Main Content -->
        <div class="col-xl-8">
            <!-- Parties -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>{% trans "Parties" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">{% trans "Petitioners" %}</h6>
                            <p class="text-muted">{{ case.petitioners|default:"Not specified" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">{% trans "Respondents" %}</h6>
                            <p class="text-muted">{{ case.respondents|default:"Not specified" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Headnotes -->
            {% if case.headnotes %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-book me-2"></i>{% trans "Headnotes" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="case-text">
                        {{ case.headnotes|linebreaksbr }}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Full Case Text -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text me-2"></i>{% trans "Full Case Text" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="case-text">
                        {{ case.case_text|linebreaksbr }}
                    </div>
                </div>
            </div>

            <!-- AI Analysis -->
            {% if case.ai_summary %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-robot me-2"></i>{% trans "AI Analysis" %}
                        <small class="text-muted">({{ case.ai_model_version|default:"v1.0" }})</small>
                    </h5>
                </div>
                <div class="card-body">
                    {% if case.ai_summary.summary %}
                    <div class="mb-3">
                        <h6>{% trans "Summary" %}</h6>
                        <p class="text-muted">{{ case.ai_summary.summary }}</p>
                    </div>
                    {% endif %}

                    {% if case.ai_summary.key_points %}
                    <div class="mb-3">
                        <h6>{% trans "Key Points" %}</h6>
                        <ul class="text-muted">
                            {% for point in case.ai_summary.key_points %}
                                <li>{{ point }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if case.ai_summary.decision %}
                    <div class="mb-3">
                        <h6>{% trans "Decision Overview" %}</h6>
                        <p class="text-muted">{{ case.ai_summary.decision }}</p>
                    </div>
                    {% endif %}

                    {% if case.extracted_principles %}
                    <div class="mb-3">
                        <h6>{% trans "Legal Principles" %}</h6>
                        <div class="row">
                            {% for principle in case.extracted_principles %}
                            <div class="col-md-6 mb-2">
                                <span class="badge bg-info">{{ principle }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if case.statutes_cited %}
                    <div class="mb-0">
                        <h6>{% trans "Statutes Cited" %}</h6>
                        <ul class="text-muted">
                            {% for statute in case.statutes_cited %}
                                <li>{{ statute }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-xl-4">
            <!-- Notes Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-pencil me-2"></i>{% trans "Your Notes" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <textarea class="form-control" id="caseNote" rows="6" placeholder="Add your notes about this case...">{{ user_note.note_text|default:"" }}</textarea>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" id="saveNoteBtn" data-case-id="{{ case.id }}">
                        <i class="bi bi-save me-1"></i>{% trans "Save Note" %}
                    </button>
                </div>
            </div>

            <!-- Related Cases -->
            {% if related_cases %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-collection me-2"></i>{% trans "Related Cases" %}
                    </h6>
                </div>
                <div class="card-body">
                    {% for related_case in related_cases %}
                    <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <h7 class="fw-semibold mb-1">
                            <a href="{% url 'legal_research:case_detail' related_case.id %}" class="text-decoration-none">
                                {{ related_case.title|truncatechars:60 }}
                            </a>
                        </h7>
                        <p class="text-muted small mb-1">
                            {{ related_case.citation }} • {{ related_case.court.name }}
                        </p>
                        <p class="text-muted small mb-2">
                            {{ related_case.judgment_date }}
                        </p>
                        <div class="d-flex gap-1">
                            {% for tag in related_case.tags.all|slice:":3" %}
                                <span class="badge bg-secondary">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Case Information -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>{% trans "Case Information" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p class="mb-2">
                            <strong>{% trans "Added" %}:</strong> {{ case.created_at }}
                        </p>
                        <p class="mb-2">
                            <strong>{% trans "Last Updated" %}:</strong> {{ case.updated_at }}
                        </p>
                        {% if case.ai_processed_at %}
                        <p class="mb-2">
                            <strong>{% trans "AI Processed" %}:</strong> {{ case.ai_processed_at }}
                        </p>
                        {% endif %}
                        {% if case.data_source %}
                        <p class="mb-0">
                            <strong>{% trans "Source" %}:</strong> {{ case.data_source }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Save case functionality
    const saveCaseBtn = document.getElementById('saveCaseBtn');
    if (saveCaseBtn) {
        saveCaseBtn.addEventListener('click', function() {
            const caseId = this.dataset.caseId;
            const isSaved = this.textContent.includes('Saved');

            fetch('/api/save-case/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.CSRF_TOKEN
                },
                body: JSON.stringify({
                    case_id: caseId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.created) {
                        this.innerHTML = '<i class="bi bi-bookmark-fill me-1"></i> Saved';
                        this.classList.add('btn-success');
                        this.classList.remove('btn-outline-primary');
                    } else {
                        this.innerHTML = '<i class="bi bi-bookmark me-1"></i> Save Case';
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-primary');
                    }
                }
            })
            .catch(error => console.error('Error saving case:', error));
        });
    }

    // Save note functionality
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const caseNote = document.getElementById('caseNote');

    if (saveNoteBtn && caseNote) {
        saveNoteBtn.addEventListener('click', function() {
            const caseId = this.dataset.caseId;
            const noteText = caseNote.value;

            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';

            fetch('/api/save-note/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.CSRF_TOKEN
                },
                body: JSON.stringify({
                    case_id: caseId,
                    note_text: noteText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.innerHTML = '<i class="bi bi-check me-1"></i> Saved!';
                    setTimeout(() => {
                        this.innerHTML = '<i class="bi bi-save me-1"></i> Save Note';
                        this.disabled = false;
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error saving note:', error);
                this.innerHTML = '<i class="bi bi-save me-1"></i> Save Note';
                this.disabled = false;
            });
        });
    }

    // Copy link functionality
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', function() {
            const currentUrl = window.location.href;
            navigator.clipboard.writeText(currentUrl).then(() => {
                this.innerHTML = '<i class="bi bi-check me-1"></i> Copied!';
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-link-45deg me-1"></i> Copy Link';
                }, 2000);
            });
        });
    }
});
</script>
{% endblock %}